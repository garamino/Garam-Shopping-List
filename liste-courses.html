<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Liste de Courses</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Application de liste de courses intelligente avec gestion de plats">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Liste Courses">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .app-logo {
            width: 64px;
            height: 64px;
            object-fit: contain;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-box {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .collapse-all-btn {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 50px;
        }

        .collapse-all-btn:hover {
            background: #5568d3;
        }

        .collapse-all-btn.collapsed {
            background: #6c757d;
        }

        .collapse-all-btn.collapsed:hover {
            background: #5a6268;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .add-item {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .add-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .add-inputs {
            display: flex;
            gap: 10px;
        }

        .add-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
        }

        .add-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-select {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .add-btn {
            width: 100%;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .add-btn:hover {
            background: #5568d3;
        }

        .category {
            padding: 20px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border-bottom: 2px solid #e9ecef;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
            border-radius: 10px;
        }

        .category-header:hover {
            background: #f8f9fa;
        }

        .category-header.collapsed {
            margin-bottom: 0;
            border-bottom: none;
        }

        .category-icon {
            font-size: 24px;
        }

        .category-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .category-count {
            margin-left: auto;
            background: #e9ecef;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .category-chevron {
            font-size: 14px;
            transition: transform 0.3s;
            color: #6c757d;
        }

        .category-chevron.collapsed {
            transform: rotate(-90deg);
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 5000px;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }

        .items-list.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            overflow: hidden;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
            cursor: move;
            user-select: none;
            position: relative;
        }

        .item:hover {
            background: #e9ecef;
            z-index: 10;
        }

        .item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .item.drag-over {
            border-top: 3px solid #667eea;
        }

        .item.checked {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
        }

        .item.checked .item-name {
            font-weight: 600;
            color: #667eea;
        }

        .item-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            margin-right: 12px;
        }

        .drag-handle {
            margin-right: 8px;
            color: #6c757d;
            cursor: move;
            font-size: 18px;
        }

        .item-name {
            flex: 1;
            font-size: 16px;
            color: #333;
        }

        .item-actions {
            display: flex;
            gap: 3px;
            margin-left: auto;
            position: relative;
        }

        .item-menu-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.3s;
            line-height: 1;
        }

        .item-menu-btn:hover {
            background: #5a6268;
        }

        .item-menu-btn.active {
            background: #667eea;
        }

        .item-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 150px;
            display: none;
            overflow: hidden;
        }

        .item-dropdown.show {
            display: block;
            animation: slideDown 0.2s;
        }

        .item-dropdown.open-upward {
            top: auto;
            bottom: 100%;
            margin-top: 0;
            margin-bottom: 5px;
        }

        .item-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #333;
        }

        .item-dropdown-item:hover {
            background: #f8f9fa;
        }

        .item-dropdown-item.rename {
            color: #28a745;
        }

        .item-dropdown-item.move {
            color: #667eea;
        }

        .item-dropdown-item.delete {
            color: #dc3545;
            border-top: 1px solid #e9ecef;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Login/Auth Modal */
        .auth-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }

        .auth-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-modal-content {
            background: white;
            padding: 40px 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            text-align: center;
        }

        .auth-modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
        }

        .auth-modal-subtitle {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 30px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .auth-button:hover {
            background: #5568d3;
        }

        .auth-button-secondary {
            background: #6c757d;
        }

        .auth-button-secondary:hover {
            background: #5a6268;
        }

        .auth-divider {
            margin: 20px 0;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.3s;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Update status icon */
        .update-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            margin-left: 10px;
            font-size: 12px;
        }

        .update-status:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .update-status-icon {
            font-size: 16px;
            animation: none;
        }

        .update-status-icon.checking {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Meals section */
        .meals-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .meals-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .meals-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-meal-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .add-meal-btn:hover {
            background: #5568d3;
        }

        .meals-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 5000px;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }

        .meals-list.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        /* Articles section */
        .articles-section {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .articles-content {
            max-height: 10000px;
            overflow: visible;
            transition: max-height 0.4s ease-out, opacity 0.4s ease-out;
            opacity: 1;
        }

        .articles-content.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .meal-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
        }

        .meal-item:hover {
            border-color: #667eea;
            z-index: 10;
        }

        .meal-item.selected {
            background: #e7f3ff;
            border-color: #667eea;
        }

        .meal-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            margin-right: 12px;
        }

        .meal-info {
            flex: 1;
        }

        .meal-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .meal-ingredients {
            font-size: 12px;
            color: #6c757d;
        }

        .meals-empty {
            text-align: center;
            padding: 30px;
            color: #6c757d;
        }

        /* Meal creation modal */
        .meal-modal-content {
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .ingredient-selector {
            margin-bottom: 20px;
        }

        .ingredient-category {
            margin-bottom: 15px;
        }

        .ingredient-category-header {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .ingredient-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 10px;
        }

        .ingredient-checkbox-item {
            display: flex;
            align-items: center;
            padding: 6px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .ingredient-checkbox-item:hover {
            background: #f8f9fa;
        }

        .ingredient-checkbox-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .ingredient-checkbox-item label {
            cursor: pointer;
            flex: 1;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .modal-category-btn {
            padding: 12px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-align: center;
        }

        .modal-category-btn:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .modal-category-btn:active {
            transform: scale(0.95);
        }

        .modal-close {
            width: 100%;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .modal-close:hover {
            background: #5a6268;
        }

        .rename-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .rename-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-confirm {
            flex: 1;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .modal-confirm:hover {
            background: #218838;
        }

        .modal-cancel {
            flex: 1;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .modal-cancel:hover {
            background: #5a6268;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .stats {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat {
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="settings-btn" onclick="openSettingsModal()" title="Param√®tres">‚öôÔ∏è</button>
            <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                <img src="header-logo.png" alt="Ma Liste de Courses" style="width: 120px; height: 120px; object-fit: contain;">
            </div>
            <div style="display: flex; justify-content: center; align-items: center; gap: 15px;">
                <span class="update-status" onclick="checkForUpdates()" title="V√©rifier les mises √† jour">
                    <span class="update-status-icon" id="updateStatusIcon">‚úÖ</span>
                    <span id="updateStatusText">√Ä jour</span>
                </span>
                <div id="syncStatus" style="font-size: 12px; opacity: 0.8;">
                    <span id="syncIcon">‚òÅÔ∏è</span> <span id="syncText">Synchronisation...</span>
                </div>
            </div>
        </div>

        <div class="meals-section">
            <div class="meals-header" onclick="toggleMealsSection()" style="cursor: pointer; user-select: none;">
                <div class="meals-title">
                    üçΩÔ∏è Mes Plats
                    <span class="category-chevron" id="mealsChevron" style="margin-left: 10px; font-size: 14px; transition: transform 0.3s;">‚ñº</span>
                </div>
                <button class="add-meal-btn" onclick="event.stopPropagation(); openMealModal()">+ Nouveau plat</button>
            </div>
            <div class="meals-list" id="mealsList"></div>
        </div>

        <div class="articles-section">
            <div class="articles-header" onclick="toggleArticlesSection()" style="cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; padding: 20px; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                <div class="articles-title" style="font-size: 18px; font-weight: 600; color: #333; display: flex; align-items: center; gap: 10px;">
                    üì¶ Mes Articles
                    <span class="category-chevron" id="articlesChevron" style="margin-left: 10px; font-size: 14px; transition: transform 0.3s;">‚ñº</span>
                </div>
                <button class="add-meal-btn" onclick="event.stopPropagation(); openAddArticleModal()">+ Nouvel article</button>
            </div>
            <div class="articles-content" id="articlesContent">
                <div class="controls">
                    <div class="search-row">
                        <input type="text" class="search-box" id="searchBox" placeholder="üîç Rechercher un article...">
                        <button class="collapse-all-btn" id="collapseAllBtn" onclick="toggleAllCategories()" title="Replier/D√©plier tout">
                            ‚¨ç
                        </button>
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">Tout</button>
                        <button class="filter-btn" data-filter="checked">√Ä acheter</button>
                        <button class="filter-btn" data-filter="active">Non s√©lectionn√©s</button>
                    </div>
                </div>

                <div id="categoriesContainer"></div>

                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="totalItems">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="checkedItems">0</div>
                        <div class="stat-label">√Ä acheter</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="remainingItems">0</div>
                        <div class="stat-label">Non s√©lectionn√©s</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for moving items -->
    <div id="moveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">D√©placer vers...</div>
            <div class="modal-categories" id="modalCategories"></div>
            <button class="modal-close" onclick="closeMoveModal()">Annuler</button>
        </div>
    </div>

    <!-- Modal for renaming items -->
    <div id="renameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Renommer l'article</div>
            <input type="text" class="rename-input" id="renameInput" placeholder="Nouveau nom...">
            <div class="modal-buttons">
                <button class="modal-confirm" onclick="confirmRename()">Confirmer</button>
                <button class="modal-cancel" onclick="closeRenameModal()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding article -->
    <div id="addArticleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Ajouter un article</div>
            <input type="text" class="rename-input" id="modalArticleName" placeholder="Nom de l'article..." style="margin-bottom: 15px;">
            <select class="rename-input" id="modalArticleCategory" style="margin-bottom: 15px; height: 45px;">
                <option value="">S√©lectionnez une cat√©gorie...</option>
                <option value="fruits">üçé Fruits</option>
                <option value="legumes">ü•¨ L√©gumes</option>
                <option value="viande">ü•© Viande</option>
                <option value="poisson">üêü Poisson</option>
                <option value="produits-laitiers">ü•õ Produits Laitiers</option>
                <option value="epicerie">ü•´ √âpicerie</option>
                <option value="boulangerie">ü•ñ Boulangerie</option>
                <option value="surgeles">‚ùÑÔ∏è Surgel√©s</option>
                <option value="boissons">ü•§ Boissons</option>
                <option value="hygiene">üß¥ Hygi√®ne & Entretien</option>
                <option value="autre">üì¶ Autre</option>
            </select>
            <div class="modal-buttons">
                <button class="modal-confirm" onclick="confirmAddArticle()">Ajouter</button>
                <button class="modal-cancel" onclick="closeAddArticleModal()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal for creating meals -->
    <div id="mealModal" class="modal">
        <div class="modal-content meal-modal-content">
            <div class="modal-header" id="mealModalHeader">Cr√©er un nouveau plat</div>
            <input type="text" class="rename-input" id="mealNameInput" placeholder="Nom du plat...">
            <div class="ingredient-selector" id="ingredientSelector"></div>
            <div class="modal-buttons">
                <button class="modal-confirm" id="mealConfirmBtn" onclick="confirmMeal()">Cr√©er le plat</button>
                <button class="modal-cancel" onclick="closeMealModal()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">üîê Connexion</div>
            <div class="auth-modal-subtitle">Entrez votre code personnel pour acc√©der √† vos donn√©es</div>
            <input type="text" class="auth-input" id="loginCodeInput" placeholder="Votre code" maxlength="30">
            <button class="auth-button" onclick="loginWithCode()">Se connecter</button>
            <div class="auth-divider">ou</div>
            <button class="auth-button auth-button-secondary" onclick="showCreateAccount()">Cr√©er un nouveau compte</button>
        </div>
    </div>

    <!-- Create Account Modal -->
    <div id="createAccountModal" class="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-modal-header">‚ú® Nouveau compte</div>
            <div class="auth-modal-subtitle">Choisissez un code personnel (minimum 4 caract√®res)</div>
            <input type="text" class="auth-input" id="newCodeInput" placeholder="Votre code" maxlength="30">
            <input type="text" class="auth-input" id="confirmCodeInput" placeholder="Confirmez le code" maxlength="30">
            <button class="auth-button" onclick="createAccount()">Cr√©er mon compte</button>
            <button class="auth-button auth-button-secondary" onclick="backToLogin()">Retour</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚öôÔ∏è Param√®tres</div>
            <div style="text-align: left; margin: 20px 0;">
                <p style="margin-bottom: 10px;"><strong>Votre code personnel :</strong></p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <code id="displayUserCode" style="font-size: 18px; font-weight: 600; color: #667eea;">---</code>
                </div>
                <p style="font-size: 13px; color: #6c757d; margin-bottom: 20px;">
                    üí° Conservez ce code pr√©cieusement ! Il vous permet de r√©cup√©rer vos donn√©es sur n'importe quel appareil.
                </p>
            </div>
            <button class="modal-confirm" onclick="logout()" style="background: #dc3545; width: 100%; margin-bottom: 10px;">
                üö™ Se d√©connecter
            </button>
            <button class="modal-cancel" onclick="closeSettingsModal()">Fermer</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDm7wU6xLy_QHVeHFwczSH5lOPTMT9yZrY",
            authDomain: "liste-course-8c2cf.firebaseapp.com",
            projectId: "liste-course-8c2cf",
            storageBucket: "liste-course-8c2cf.firebasestorage.app",
            messagingSenderId: "426451396001",
            appId: "1:426451396001:web:4789552edad9f52f5c97e0"
        };

        // Initialize Firebase
        let db = null;
        let userId = null;
        let isFirebaseReady = false;

        // Generate or retrieve user ID
        function getUserId() {
            let uid = localStorage.getItem('userCode');
            if (!uid) {
                // No code found, user needs to login or create account
                return null;
            }
            // Hash the code for security (simple hash)
            return 'user_' + btoa(uid).replace(/[^a-zA-Z0-9]/g, '');
        }

        function checkAuthStatus() {
            const userCode = localStorage.getItem('userCode');
            if (!userCode) {
                // Show login modal
                document.getElementById('authModal').classList.add('show');
                return false;
            }
            return true;
        }

        function loginWithCode() {
            const code = document.getElementById('loginCodeInput').value.trim();
            
            if (!code) {
                alert('Veuillez entrer votre code');
                return;
            }

            if (code.length < 4) {
                alert('Le code doit contenir au moins 4 caract√®res');
                return;
            }

            // Save the code
            localStorage.setItem('userCode', code);
            userId = getUserId();
            
            // Close modal
            document.getElementById('authModal').classList.remove('show');
            
            // Reload data with new userId
            location.reload();
        }

        function showCreateAccount() {
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('createAccountModal').classList.add('show');
        }

        function backToLogin() {
            document.getElementById('createAccountModal').classList.remove('show');
            document.getElementById('authModal').classList.add('show');
        }

        function createAccount() {
            const code = document.getElementById('newCodeInput').value.trim();
            const confirmCode = document.getElementById('confirmCodeInput').value.trim();
            
            if (!code || !confirmCode) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            if (code.length < 4) {
                alert('Le code doit contenir au moins 4 caract√®res');
                return;
            }

            if (code !== confirmCode) {
                alert('Les codes ne correspondent pas');
                return;
            }

            // Save the code
            localStorage.setItem('userCode', code);
            userId = getUserId();
            
            // Close modal
            document.getElementById('createAccountModal').classList.remove('show');
            
            // Initialize app
            location.reload();
        }

        function openSettingsModal() {
            const userCode = localStorage.getItem('userCode');
            document.getElementById('displayUserCode').textContent = userCode || 'Non d√©fini';
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ? Assurez-vous de conna√Ætre votre code pour vous reconnecter !')) {
                localStorage.removeItem('userCode');
                location.reload();
            }
        }

        // Initialize Firebase when the page loads
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // Check if user is authenticated
            if (!checkAuthStatus()) {
                console.log('‚è≥ En attente de connexion utilisateur...');
                // Don't set userId yet, wait for login
            } else {
                userId = getUserId();
                
                // Check if we're on HTTPS (Firebase requires it)
                if (window.location.protocol === 'https:') {
                    isFirebaseReady = true;
                    console.log('‚úÖ Firebase initialis√© (HTTPS d√©tect√©)');
                } else {
                    isFirebaseReady = false;
                    console.log('‚ö†Ô∏è Firebase d√©sactiv√© (HTTPS requis). Utilisation localStorage uniquement.');
                }
            }
        } catch (error) {
            console.error('‚ùå Erreur Firebase:', error);
            isFirebaseReady = false;
        }

        // ========================================
        // APPLICATION DATA
        // ========================================
        const CATEGORIES = {
            'fruits': { name: 'Fruits', icon: 'üçé', items: [] },
            'legumes': { name: 'L√©gumes', icon: 'ü•¨', items: [] },
            'viande': { name: 'Viande', icon: 'ü•©', items: [] },
            'poisson': { name: 'Poisson', icon: 'üêü', items: [] },
            'produits-laitiers': { name: 'Produits Laitiers', icon: 'ü•õ', items: ['Lait', 'Yaourts', 'Fromage', 'Beurre', 'Oeufs'] },
            'epicerie': { name: '√âpicerie', icon: 'ü•´', items: ['P√¢tes', 'Riz', 'Huile', 'Sauce tomate', 'Sel', 'Poivre', 'Sucre', 'Farine'] },
            'boulangerie': { name: 'Boulangerie', icon: 'ü•ñ', items: ['Pain', 'Croissants', 'Brioche'] },
            'surgeles': { name: 'Surgel√©s', icon: '‚ùÑÔ∏è', items: ['Pizza', 'L√©gumes surgel√©s', 'Glace'] },
            'boissons': { name: 'Boissons', icon: 'ü•§', items: ['Eau', 'Jus d\'orange', 'Caf√©', 'Th√©', 'Soda'] },
            'hygiene': { name: 'Hygi√®ne & Entretien', icon: 'üß¥', items: ['Savon', 'Shampoing', 'Dentifrice', 'Lessive', 'Papier toilette'] },
            'autre': { name: 'Autre', icon: 'üì¶', items: [] }
        };

        let groceryList = {};
        let currentFilter = 'all';
        let searchTerm = '';
        let collapsedCategories = {};
        let meals = {};
        let mealsCollapsed = false;
        let articlesCollapsed = false;

        // Initialize with some default items
        async function initializeDefaultItems() {
            const savedCollapsed = localStorage.getItem('collapsedCategories');
            const saved = localStorage.getItem('groceryList');
            const savedMeals = localStorage.getItem('meals');
            const savedMealsCollapsed = localStorage.getItem('mealsCollapsed');
            const savedArticlesCollapsed = localStorage.getItem('articlesCollapsed');
            
            if (savedCollapsed) {
                collapsedCategories = JSON.parse(savedCollapsed);
            }

            if (savedMealsCollapsed !== null) {
                mealsCollapsed = savedMealsCollapsed === 'true';
            }

            if (savedArticlesCollapsed !== null) {
                articlesCollapsed = savedArticlesCollapsed === 'true';
            }

            // Try to load from Firebase first (only works on HTTPS)
            const loadedFromFirebase = await loadFromFirebase();
            
            if (loadedFromFirebase) {
                console.log('‚úÖ Donn√©es charg√©es depuis Firebase');
                return;
            }

            // If no Firebase data, load from localStorage
            console.log('üìÇ Chargement depuis localStorage...');
            
            if (savedMeals) {
                meals = JSON.parse(savedMeals);
            }
            
            if (saved) {
                groceryList = JSON.parse(saved);
                
                // Migration: split old combined categories into new separate ones
                if (groceryList['fruits-legumes']) {
                    // Separate fruits and vegetables
                    const fruitsKeywords = ['citron', 'lime', 'orange', 'pomme', 'banane', 'baie', 'fraise', 'myrtille', 'framboise', 'raisin', 'mangue', 'ananas', 'avocat', 'kiwi', 'poire'];
                    
                    groceryList['fruits'] = groceryList['fruits'] || [];
                    groceryList['legumes'] = groceryList['legumes'] || [];
                    
                    groceryList['fruits-legumes'].forEach(item => {
                        const itemLower = item.name.toLowerCase();
                        const isFruit = fruitsKeywords.some(keyword => itemLower.includes(keyword));
                        
                        if (isFruit) {
                            groceryList['fruits'].push(item);
                        } else {
                            groceryList['legumes'].push(item);
                        }
                    });
                    
                    delete groceryList['fruits-legumes'];
                }
                
                if (groceryList['viande-poisson']) {
                    // Separate meat and fish
                    const fishKeywords = ['saumon', 'thon', 'crevette', 'moule', 'cabillaud', 'poisson'];
                    
                    groceryList['viande'] = groceryList['viande'] || [];
                    groceryList['poisson'] = groceryList['poisson'] || [];
                    
                    groceryList['viande-poisson'].forEach(item => {
                        const itemLower = item.name.toLowerCase();
                        const isFish = fishKeywords.some(keyword => itemLower.includes(keyword));
                        
                        if (isFish) {
                            groceryList['poisson'].push(item);
                        } else {
                            groceryList['viande'].push(item);
                        }
                    });
                    
                    delete groceryList['viande-poisson'];
                }
                
                saveToLocalStorage();
            } else {
                // Add items from user's list
                let idCounter = Date.now();
                groceryList = {
                    'fruits': [
                        { name: 'Citrons', checked: false, id: idCounter++ },
                        { name: 'Limes', checked: false, id: idCounter++ },
                        { name: 'Oranges', checked: false, id: idCounter++ },
                        { name: 'Pommes', checked: false, id: idCounter++ },
                        { name: 'Bananes', checked: false, id: idCounter++ },
                        { name: 'Baies (fraises, myrtilles, framboises)', checked: false, id: idCounter++ },
                        { name: 'Raisins', checked: false, id: idCounter++ },
                        { name: 'Mangues', checked: false, id: idCounter++ },
                        { name: 'Ananas', checked: false, id: idCounter++ },
                        { name: 'Avocats', checked: false, id: idCounter++ },
                        { name: 'Kiwis', checked: false, id: idCounter++ },
                        { name: 'Poires', checked: false, id: idCounter++ }
                    ],
                    'legumes': [
                        { name: 'Tomates', checked: false, id: idCounter++ },
                        { name: 'Brocoli', checked: false, id: idCounter++ },
                        { name: 'Poivrons', checked: false, id: idCounter++ },
                        { name: 'Oignon', checked: false, id: idCounter++ },
                        { name: 'Ail', checked: false, id: idCounter++ },
                        { name: 'Pommes de terre', checked: false, id: idCounter++ },
                        { name: 'Patates douces', checked: false, id: idCounter++ },
                        { name: 'Carottes', checked: false, id: idCounter++ },
                        { name: 'Poireaux', checked: false, id: idCounter++ },
                        { name: 'C√©leri', checked: false, id: idCounter++ },
                        { name: 'Choux de Bruxelles', checked: false, id: idCounter++ },
                        { name: 'Champignons', checked: false, id: idCounter++ },
                        { name: 'Courgettes', checked: false, id: idCounter++ },
                        { name: 'Aubergines', checked: false, id: idCounter++ },
                        { name: 'Betteraves', checked: false, id: idCounter++ },
                        { name: 'Concombre', checked: false, id: idCounter++ },
                        { name: 'Salade/Laitue', checked: false, id: idCounter++ },
                        { name: '√âpinards', checked: false, id: idCounter++ },
                        { name: 'Roquette', checked: false, id: idCounter++ },
                        { name: 'Herbes fra√Æches (basilic, persil, coriandre)', checked: false, id: idCounter++ }
                    ],
                    'viande': [
                        { name: 'Poulet (entier, cuisses, poitrines)', checked: false, id: idCounter++ },
                        { name: 'B≈ìuf hach√©', checked: false, id: idCounter++ },
                        { name: 'Steaks', checked: false, id: idCounter++ },
                        { name: 'Porc (c√¥telettes, r√¥ti)', checked: false, id: idCounter++ },
                        { name: 'Saucisses', checked: false, id: idCounter++ },
                        { name: 'Bacon', checked: false, id: idCounter++ },
                        { name: 'Agneau', checked: false, id: idCounter++ },
                        { name: 'Dinde', checked: false, id: idCounter++ }
                    ],
                    'poisson': [
                        { name: 'Saumon', checked: false, id: idCounter++ },
                        { name: 'Thon', checked: false, id: idCounter++ },
                        { name: 'Crevettes', checked: false, id: idCounter++ },
                        { name: 'Moules', checked: false, id: idCounter++ },
                        { name: 'Cabillaud ou autre poisson blanc', checked: false, id: idCounter++ }
                    ],
                    'produits-laitiers': [
                        { name: 'Lait (entier, √©cr√©m√©, alternatif)', checked: false, id: idCounter++ },
                        { name: 'Cr√®me fra√Æche/Cr√®me liquide', checked: false, id: idCounter++ },
                        { name: 'Beurre', checked: false, id: idCounter++ },
                        { name: 'Yaourt nature', checked: false, id: idCounter++ },
                        { name: 'Yaourt grec', checked: false, id: idCounter++ },
                        { name: 'Fromage (cheddar, mozzarella, parmesan)', checked: false, id: idCounter++ },
                        { name: 'Fromage blanc/Cottage cheese', checked: false, id: idCounter++ },
                        { name: '≈íufs', checked: false, id: idCounter++ }
                    ],
                    'epicerie': [
                        { name: 'Pain', checked: false, id: idCounter++ },
                        { name: 'P√¢tes', checked: false, id: idCounter++ },
                        { name: 'Riz (blanc, brun, basmati)', checked: false, id: idCounter++ },
                        { name: 'Quinoa', checked: false, id: idCounter++ },
                        { name: 'Couscous', checked: false, id: idCounter++ },
                        { name: 'Farine', checked: false, id: idCounter++ },
                        { name: 'Sucre', checked: false, id: idCounter++ },
                        { name: 'Cassonade', checked: false, id: idCounter++ },
                        { name: 'Levure chimique', checked: false, id: idCounter++ },
                        { name: 'Bicarbonate de soude', checked: false, id: idCounter++ },
                        { name: 'Sel', checked: false, id: idCounter++ },
                        { name: 'Poivre noir', checked: false, id: idCounter++ },
                        { name: 'Flocons d\'avoine', checked: false, id: idCounter++ },
                        { name: 'C√©r√©ales', checked: false, id: idCounter++ },
                        { name: 'P√¢te √† tartiner', checked: false, id: idCounter++ },
                        { name: 'Confiture', checked: false, id: idCounter++ },
                        { name: 'Miel', checked: false, id: idCounter++ },
                        { name: 'Beurre de cacahu√®te', checked: false, id: idCounter++ },
                        { name: 'Huile d\'olive', checked: false, id: idCounter++ },
                        { name: 'Huile v√©g√©tale', checked: false, id: idCounter++ },
                        { name: 'Vinaigre (balsamique, de vin)', checked: false, id: idCounter++ },
                        { name: 'Sauce soja', checked: false, id: idCounter++ },
                        { name: 'Ketchup', checked: false, id: idCounter++ },
                        { name: 'Moutarde', checked: false, id: idCounter++ },
                        { name: 'Mayonnaise', checked: false, id: idCounter++ },
                        { name: 'P√¢te de tomate', checked: false, id: idCounter++ },
                        { name: 'Tomates en conserve', checked: false, id: idCounter++ },
                        { name: 'Haricots en conserve (noirs, rouges, blancs)', checked: false, id: idCounter++ },
                        { name: 'Pois chiches', checked: false, id: idCounter++ },
                        { name: 'Lentilles', checked: false, id: idCounter++ },
                        { name: 'Bouillon (l√©gumes, poulet, b≈ìuf)', checked: false, id: idCounter++ },
                        { name: 'Lait de coco', checked: false, id: idCounter++ },
                        { name: 'Noix (amandes, noix de cajou, noix)', checked: false, id: idCounter++ },
                        { name: 'Graines (chia, lin, tournesol)', checked: false, id: idCounter++ },
                        { name: 'Chocolat noir', checked: false, id: idCounter++ },
                        { name: 'P√©pites de chocolat', checked: false, id: idCounter++ },
                        { name: 'Thon en conserve', checked: false, id: idCounter++ },
                        { name: 'Sardines', checked: false, id: idCounter++ },
                        { name: 'Cornichons', checked: false, id: idCounter++ },
                        { name: 'Olives', checked: false, id: idCounter++ }
                    ],
                    'surgeles': [
                        { name: 'L√©gumes surgel√©s (pois, ma√Øs, haricots verts)', checked: false, id: idCounter++ },
                        { name: 'Fruits surgel√©s (baies)', checked: false, id: idCounter++ },
                        { name: 'Pizza surgel√©e', checked: false, id: idCounter++ },
                        { name: 'Glace', checked: false, id: idCounter++ }
                    ],
                    'boissons': [
                        { name: 'Eau en bouteille/eau gazeuse', checked: false, id: idCounter++ },
                        { name: 'Jus (orange, pomme)', checked: false, id: idCounter++ },
                        { name: 'Caf√©', checked: false, id: idCounter++ },
                        { name: 'Th√© (noir, vert, tisanes)', checked: false, id: idCounter++ },
                        { name: 'Sodas', checked: false, id: idCounter++ },
                        { name: 'Bi√®re/Vin', checked: false, id: idCounter++ }
                    ],
                    'hygiene': [
                        { name: 'Papier toilette', checked: false, id: idCounter++ },
                        { name: 'Essuie-tout', checked: false, id: idCounter++ },
                        { name: 'Mouchoirs', checked: false, id: idCounter++ },
                        { name: 'Savon √† vaisselle', checked: false, id: idCounter++ },
                        { name: 'Lessive', checked: false, id: idCounter++ },
                        { name: 'Sacs poubelle', checked: false, id: idCounter++ },
                        { name: '√âponges', checked: false, id: idCounter++ },
                        { name: 'Film alimentaire', checked: false, id: idCounter++ },
                        { name: 'Papier aluminium', checked: false, id: idCounter++ },
                        { name: 'Sacs de cong√©lation', checked: false, id: idCounter++ },
                        { name: 'Dentifrice', checked: false, id: idCounter++ },
                        { name: 'Brosses √† dents', checked: false, id: idCounter++ },
                        { name: 'Shampoing', checked: false, id: idCounter++ },
                        { name: 'Apr√®s-shampoing', checked: false, id: idCounter++ },
                        { name: 'Gel douche', checked: false, id: idCounter++ },
                        { name: 'D√©odorant', checked: false, id: idCounter++ },
                        { name: 'Rasoirs', checked: false, id: idCounter++ },
                        { name: 'Cr√®me √† raser', checked: false, id: idCounter++ }
                    ],
                    'autre': [
                        { name: 'Nourriture pour animaux (si applicable)', checked: false, id: idCounter++ },
                        { name: 'Serviettes en papier', checked: false, id: idCounter++ },
                        { name: 'Bougies', checked: false, id: idCounter++ },
                        { name: 'Allumettes/Briquets', checked: false, id: idCounter++ },
                        { name: 'Piles', checked: false, id: idCounter++ }
                    ]
                };
                saveToLocalStorage();
            }
        }

        function saveToLocalStorage() {
            // Save to localStorage (backup)
            localStorage.setItem('groceryList', JSON.stringify(groceryList));
            localStorage.setItem('collapsedCategories', JSON.stringify(collapsedCategories));
            localStorage.setItem('meals', JSON.stringify(meals));
            localStorage.setItem('mealsCollapsed', mealsCollapsed.toString());
            localStorage.setItem('articlesCollapsed', articlesCollapsed.toString());
            
            // Save to Firebase
            saveToFirebase();
        }

        async function saveToFirebase() {
            if (!isFirebaseReady || !db || !userId) {
                console.log('Firebase non disponible, sauvegarde locale uniquement');
                updateSyncStatus('offline');
                return;
            }

            try {
                updateSyncStatus('syncing');
                
                const dataToSave = {
                    groceryList: groceryList,
                    meals: meals,
                    collapsedCategories: collapsedCategories,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('users').doc(userId).set(dataToSave, { merge: true });
                console.log('‚úÖ Donn√©es sauvegard√©es sur Firebase');
                updateSyncStatus('synced');
            } catch (error) {
                console.error('‚ùå Erreur de sauvegarde Firebase:', error);
                updateSyncStatus('error');
            }
        }

        function updateSyncStatus(status) {
            const iconEl = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            
            if (!iconEl || !textEl) return;
            
            switch(status) {
                case 'syncing':
                    iconEl.textContent = 'üîÑ';
                    textEl.textContent = 'Synchronisation...';
                    break;
                case 'synced':
                    iconEl.textContent = '‚úÖ';
                    textEl.textContent = 'Sauvegard√© dans le cloud';
                    setTimeout(() => {
                        iconEl.textContent = '‚òÅÔ∏è';
                        textEl.textContent = 'Connect√©';
                    }, 2000);
                    break;
                case 'offline':
                    iconEl.textContent = 'üíæ';
                    textEl.textContent = 'Sauvegarde locale uniquement';
                    break;
                case 'error':
                    iconEl.textContent = '‚ö†Ô∏è';
                    textEl.textContent = 'Erreur de synchronisation';
                    break;
            }
        }

        async function loadFromFirebase() {
            if (!isFirebaseReady || !db || !userId) {
                console.log('Firebase non disponible, chargement depuis localStorage');
                updateSyncStatus('offline');
                return false;
            }

            try {
                updateSyncStatus('syncing');
                const doc = await db.collection('users').doc(userId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    console.log('üì• Donn√©es charg√©es depuis Firebase');
                    
                    if (data.groceryList) groceryList = data.groceryList;
                    if (data.meals) meals = data.meals;
                    if (data.collapsedCategories) collapsedCategories = data.collapsedCategories;
                    
                    // Save to localStorage as backup
                    localStorage.setItem('groceryList', JSON.stringify(groceryList));
                    localStorage.setItem('meals', JSON.stringify(meals));
                    localStorage.setItem('collapsedCategories', JSON.stringify(collapsedCategories));
                    
                    updateSyncStatus('synced');
                    return true;
                } else {
                    console.log('Aucune donn√©e Firebase, utilisation localStorage');
                    updateSyncStatus('offline');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erreur de chargement Firebase:', error);
                updateSyncStatus('error');
                return false;
            }
        }

        function toggleCategory(categoryKey) {
            collapsedCategories[categoryKey] = !collapsedCategories[categoryKey];
            saveToLocalStorage();
            
            // Animate the toggle
            const header = event.target.closest('.category-header');
            const itemsList = header.nextElementSibling;
            const chevron = header.querySelector('.category-chevron');
            
            if (collapsedCategories[categoryKey]) {
                header.classList.add('collapsed');
                itemsList.classList.add('collapsed');
                chevron.classList.add('collapsed');
            } else {
                header.classList.remove('collapsed');
                itemsList.classList.remove('collapsed');
                chevron.classList.remove('collapsed');
            }
        }

        function toggleAllCategories() {
            const btn = document.getElementById('collapseAllBtn');
            const allCollapsed = Object.keys(CATEGORIES).every(key => collapsedCategories[key]);
            
            // Toggle all categories
            Object.keys(CATEGORIES).forEach(categoryKey => {
                collapsedCategories[categoryKey] = !allCollapsed;
            });
            
            // Update button state
            if (!allCollapsed) {
                btn.classList.add('collapsed');
                btn.textContent = '‚¨ç';
                btn.title = 'D√©plier tout';
            } else {
                btn.classList.remove('collapsed');
                btn.textContent = '‚¨ç';
                btn.title = 'Replier tout';
            }
            
            saveToLocalStorage();
            renderCategories();
        }

        function openAddArticleModal() {
            const modal = document.getElementById('addArticleModal');
            const nameInput = document.getElementById('modalArticleName');
            const categorySelect = document.getElementById('modalArticleCategory');
            
            nameInput.value = '';
            categorySelect.value = '';
            modal.classList.add('show');
            
            setTimeout(() => {
                nameInput.focus();
            }, 100);
        }

        function closeAddArticleModal() {
            const modal = document.getElementById('addArticleModal');
            modal.classList.remove('show');
        }

        function confirmAddArticle() {
            const nameInput = document.getElementById('modalArticleName');
            const categorySelect = document.getElementById('modalArticleCategory');
            
            const itemName = nameInput.value.trim();
            const category = categorySelect.value;
            
            if (!itemName) {
                alert('Veuillez entrer un nom pour l\'article');
                return;
            }
            
            if (!category) {
                alert('Veuillez s√©lectionner une cat√©gorie');
                return;
            }
            
            addItem(itemName, category);
            closeAddArticleModal();
        }

        function addItem(itemName, category) {
            if (!itemName.trim()) return;
            
            if (!groceryList[category]) {
                groceryList[category] = [];
            }

            groceryList[category].push({
                name: itemName.trim(),
                checked: false,
                id: Date.now()
            });

            saveToLocalStorage();
            renderCategories();
            document.getElementById('newItemInput').value = '';
        }

        function toggleItem(category, itemId) {
            const item = groceryList[category].find(i => i.id === itemId);
            if (item) {
                item.checked = !item.checked;
                saveToLocalStorage();
                renderCategories();
            }
        }

        function deleteItem(category, itemId) {
            groceryList[category] = groceryList[category].filter(i => i.id !== itemId);
            if (groceryList[category].length === 0) {
                delete groceryList[category];
            }
            saveToLocalStorage();
            renderCategories();
        }

        // Move item modal functions
        let currentMoveItem = null;

        function openMoveModal(fromCategory, itemId) {
            currentMoveItem = { fromCategory, itemId };
            const modal = document.getElementById('moveModal');
            const categoriesContainer = document.getElementById('modalCategories');
            
            // Build category buttons (exclude current category)
            categoriesContainer.innerHTML = '';
            Object.keys(CATEGORIES).forEach(categoryKey => {
                if (categoryKey !== fromCategory) {
                    const category = CATEGORIES[categoryKey];
                    const btn = document.createElement('button');
                    btn.className = 'modal-category-btn';
                    btn.innerHTML = `${category.icon} ${category.name}`;
                    btn.onclick = () => moveItemToCategory(categoryKey);
                    categoriesContainer.appendChild(btn);
                }
            });
            
            modal.classList.add('show');
        }

        function closeMoveModal() {
            const modal = document.getElementById('moveModal');
            modal.classList.remove('show');
            currentMoveItem = null;
        }

        function moveItemToCategory(toCategory) {
            if (!currentMoveItem) return;
            
            const { fromCategory, itemId } = currentMoveItem;
            const itemIndex = groceryList[fromCategory].findIndex(item => item.id === itemId);
            
            if (itemIndex !== -1) {
                const [item] = groceryList[fromCategory].splice(itemIndex, 1);
                
                if (!groceryList[toCategory]) {
                    groceryList[toCategory] = [];
                }
                groceryList[toCategory].push(item);
                
                if (groceryList[fromCategory].length === 0) {
                    delete groceryList[fromCategory];
                }
                
                saveToLocalStorage();
                renderCategories();
            }
            
            closeMoveModal();
        }

        // Rename item modal functions
        let currentRenameItem = null;

        function openRenameModal(category, itemId) {
            currentRenameItem = { category, itemId };
            const item = groceryList[category].find(i => i.id === itemId);
            
            if (item) {
                const modal = document.getElementById('renameModal');
                const input = document.getElementById('renameInput');
                input.value = item.name;
                modal.classList.add('show');
                
                // Focus and select text
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 100);
            }
        }

        function closeRenameModal() {
            const modal = document.getElementById('renameModal');
            modal.classList.remove('show');
            currentRenameItem = null;
            currentRenameMeal = null;
        }

        function confirmRename() {
            // Check if we're renaming a meal or an item
            if (currentRenameMeal !== null) {
                confirmRenameMeal();
                return;
            }
            
            if (!currentRenameItem) return;
            
            const { category, itemId } = currentRenameItem;
            const newName = document.getElementById('renameInput').value.trim();
            
            if (newName) {
                const item = groceryList[category].find(i => i.id === itemId);
                if (item) {
                    item.name = newName;
                    saveToLocalStorage();
                    renderCategories();
                }
            }
            
            closeRenameModal();
        }

        // Meal management functions
        function renderMeals() {
            const container = document.getElementById('mealsList');
            const mealKeys = Object.keys(meals);

            if (mealKeys.length === 0) {
                container.innerHTML = `
                    <div class="meals-empty">
                        Aucun plat cr√©√©. Cliquez sur "+ Nouveau plat" pour commencer.
                    </div>
                `;
                return;
            }

            container.innerHTML = mealKeys.map(mealId => {
                const meal = meals[mealId];
                const ingredientCount = meal.ingredients.length;
                const ingredientNames = meal.ingredients.map(ing => {
                    const items = groceryList[ing.category] || [];
                    // Compare as strings to handle both number and string IDs
                    const item = items.find(i => String(i.id) === String(ing.itemId));
                    return item ? item.name : '';
                }).filter(Boolean).slice(0, 3).join(', ');
                const moreText = ingredientCount > 3 ? ` +${ingredientCount - 3} autres` : '';

                return `
                    <div class="meal-item ${meal.selected ? 'selected' : ''}" 
                         id="meal-${mealId}"
                         draggable="true"
                         data-meal-id="${mealId}">
                        <span class="drag-handle" style="cursor: grab; color: #adb5bd; margin-right: 8px;">‚ãÆ‚ãÆ</span>
                        <input type="checkbox" class="meal-checkbox" 
                               ${meal.selected ? 'checked' : ''}
                               onchange="toggleMeal(${mealId})">
                        <div class="meal-info">
                            <div class="meal-name">${meal.name}</div>
                            <div class="meal-ingredients">${ingredientNames}${moreText}</div>
                        </div>
                        <div class="item-actions">
                            <button class="item-menu-btn" onclick="toggleMealMenu(event, ${mealId})" title="Actions">
                                ‚ãÆ
                            </button>
                            <div class="item-dropdown" id="meal-menu-${mealId}">
                                <button class="item-dropdown-item rename" onclick="openRenameMealModal(${mealId}); closeAllMealMenus();">
                                    ‚úèÔ∏è Renommer
                                </button>
                                <button class="item-dropdown-item move" onclick="openEditMealModal(${mealId}); closeAllMealMenus();">
                                    üç¥ Modifier ingr√©dients
                                </button>
                                <button class="item-dropdown-item delete" onclick="deleteMeal(${mealId}); closeAllMealMenus();">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Apply collapsed state
            updateMealsCollapseState();
            
            // Initialize drag and drop for meals
            initializeMealsDragAndDrop();
        }

        function toggleMealsSection() {
            mealsCollapsed = !mealsCollapsed;
            saveToLocalStorage();
            updateMealsCollapseState();
        }

        function updateMealsCollapseState() {
            const mealsList = document.getElementById('mealsList');
            const chevron = document.getElementById('mealsChevron');
            
            if (mealsCollapsed) {
                mealsList.classList.add('collapsed');
                if (chevron) chevron.classList.add('collapsed');
            } else {
                mealsList.classList.remove('collapsed');
                if (chevron) chevron.classList.remove('collapsed');
            }
        }

        function toggleArticlesSection() {
            articlesCollapsed = !articlesCollapsed;
            saveToLocalStorage();
            updateArticlesCollapseState();
        }

        function updateArticlesCollapseState() {
            const articlesContent = document.getElementById('articlesContent');
            const chevron = document.getElementById('articlesChevron');
            
            if (articlesCollapsed) {
                articlesContent.classList.add('collapsed');
                if (chevron) chevron.classList.add('collapsed');
            } else {
                articlesContent.classList.remove('collapsed');
                if (chevron) chevron.classList.remove('collapsed');
            }
        }

        function openMealModal() {
            const modal = document.getElementById('mealModal');
            const selector = document.getElementById('ingredientSelector');
            const header = document.getElementById('mealModalHeader');
            const confirmBtn = document.getElementById('mealConfirmBtn');
            const nameInput = document.getElementById('mealNameInput');
            
            // Set to create mode
            header.textContent = 'Cr√©er un nouveau plat';
            confirmBtn.textContent = 'Cr√©er le plat';
            nameInput.disabled = false;
            
            // Build ingredient selector with all items grouped by category
            let html = '';
            Object.keys(CATEGORIES).forEach(categoryKey => {
                const items = groceryList[categoryKey] || [];
                if (items.length > 0) {
                    const category = CATEGORIES[categoryKey];
                    html += `
                        <div class="ingredient-category">
                            <div class="ingredient-category-header">
                                ${category.icon} ${category.name}
                            </div>
                            <div class="ingredient-list">
                                ${items.map(item => {
                                    // Use JSON to safely encode both category and itemId
                                    const value = JSON.stringify({ category: categoryKey, itemId: item.id });
                                    return `
                                        <div class="ingredient-checkbox-item">
                                            <input type="checkbox" 
                                                   id="ing-${categoryKey}-${item.id}"
                                                   value='${value}'>
                                            <label for="ing-${categoryKey}-${item.id}">${item.name}</label>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            selector.innerHTML = html;
            document.getElementById('mealNameInput').value = '';
            modal.classList.add('show');
        }

        function closeMealModal() {
            const modal = document.getElementById('mealModal');
            const nameInput = document.getElementById('mealNameInput');
            modal.classList.remove('show');
            nameInput.disabled = false;
            currentEditMeal = null;
        }

        function confirmMeal() {
            // Check if we're editing or creating
            if (currentEditMeal !== null) {
                confirmEditMeal();
                return;
            }
            
            const name = document.getElementById('mealNameInput').value.trim();
            if (!name) {
                alert('Veuillez entrer un nom pour le plat');
                return;
            }

            // Get selected ingredients
            const checkboxes = document.querySelectorAll('#ingredientSelector input[type="checkbox"]:checked');
            const ingredients = Array.from(checkboxes).map(cb => {
                try {
                    return JSON.parse(cb.value);
                } catch (e) {
                    console.error('Error parsing ingredient:', cb.value, e);
                    return null;
                }
            }).filter(Boolean);

            if (ingredients.length === 0) {
                alert('Veuillez s√©lectionner au moins un ingr√©dient');
                return;
            }

            // Create meal
            const mealId = Date.now();
            meals[mealId] = {
                name,
                ingredients,
                selected: false
            };

            saveToLocalStorage();
            renderMeals();
            closeMealModal();
        }

        function toggleMeal(mealId) {
            const meal = meals[mealId];
            meal.selected = !meal.selected;

            console.log('Toggling meal:', meal.name, 'to', meal.selected);
            console.log('Ingredients:', meal.ingredients);

            // Toggle all ingredients in the grocery list
            meal.ingredients.forEach(ing => {
                console.log('Looking for ingredient:', ing);
                const items = groceryList[ing.category] || [];
                console.log('Items in category', ing.category, ':', items.map(i => ({ id: i.id, name: i.name })));
                
                // Try exact match first, then string comparison
                let item = items.find(i => i.id === ing.itemId);
                if (!item) {
                    item = items.find(i => String(i.id) === String(ing.itemId));
                }
                
                if (item) {
                    console.log('Found item:', item.name, 'setting checked to', meal.selected);
                    item.checked = meal.selected;
                } else {
                    console.log('Item not found! Looking for id:', ing.itemId, 'type:', typeof ing.itemId);
                }
            });

            saveToLocalStorage();
            renderMeals();
            renderCategories();
        }

        function deleteMeal(mealId) {
            if (confirm('Voulez-vous vraiment supprimer ce plat ?')) {
                delete meals[mealId];
                saveToLocalStorage();
                renderMeals();
            }
        }

        // Meal menu functions
        function toggleMealMenu(event, mealId) {
            event.stopPropagation();
            const menuId = `meal-menu-${mealId}`;
            const menu = document.getElementById(menuId);
            const button = event.target;
            
            // Close all other menus
            document.querySelectorAll('.item-dropdown').forEach(dropdown => {
                if (dropdown.id !== menuId) {
                    dropdown.classList.remove('show');
                    dropdown.classList.remove('open-upward');
                }
            });
            
            // Remove active state from all buttons
            document.querySelectorAll('.item-menu-btn').forEach(btn => {
                if (btn !== button) {
                    btn.classList.remove('active');
                }
            });
            
            // Toggle current menu
            menu.classList.toggle('show');
            button.classList.toggle('active');
            
            // Check if menu should open upward
            if (menu.classList.contains('show')) {
                setTimeout(() => {
                    const rect = menu.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    
                    // If menu would be cut off at bottom, open upward
                    if (rect.bottom > viewportHeight - 20) {
                        menu.classList.add('open-upward');
                    } else {
                        menu.classList.remove('open-upward');
                    }
                }, 10);
            }
        }

        function closeAllMealMenus() {
            document.querySelectorAll('.item-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
                dropdown.classList.remove('open-upward');
            });
            document.querySelectorAll('.item-menu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // Rename meal
        let currentRenameMeal = null;

        function openRenameMealModal(mealId) {
            currentRenameMeal = mealId;
            const meal = meals[mealId];
            
            if (meal) {
                const modal = document.getElementById('renameModal');
                const input = document.getElementById('renameInput');
                input.value = meal.name;
                modal.classList.add('show');
                
                // Focus and select text
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 100);
            }
        }

        function confirmRenameMeal() {
            if (currentRenameMeal === null) return;
            
            const newName = document.getElementById('renameInput').value.trim();
            
            if (newName) {
                const meal = meals[currentRenameMeal];
                if (meal) {
                    meal.name = newName;
                    saveToLocalStorage();
                    renderMeals();
                }
            }
            
            closeRenameModal();
            currentRenameMeal = null;
        }

        // Edit meal ingredients
        let currentEditMeal = null;

        function openEditMealModal(mealId) {
            currentEditMeal = mealId;
            const meal = meals[mealId];
            
            if (meal) {
                const modal = document.getElementById('mealModal');
                const selector = document.getElementById('ingredientSelector');
                const nameInput = document.getElementById('mealNameInput');
                const header = document.getElementById('mealModalHeader');
                const confirmBtn = document.getElementById('mealConfirmBtn');
                
                // Set to edit mode
                header.textContent = 'Modifier les ingr√©dients';
                confirmBtn.textContent = 'Enregistrer';
                nameInput.value = meal.name;
                nameInput.disabled = true;
                
                // Build ingredient selector with current selections checked
                let html = '';
                Object.keys(CATEGORIES).forEach(categoryKey => {
                    const items = groceryList[categoryKey] || [];
                    if (items.length > 0) {
                        const category = CATEGORIES[categoryKey];
                        html += `
                            <div class="ingredient-category">
                                <div class="ingredient-category-header">
                                    ${category.icon} ${category.name}
                                </div>
                                <div class="ingredient-list">
                                    ${items.map(item => {
                                        const value = JSON.stringify({ category: categoryKey, itemId: item.id });
                                        // Check if this ingredient is in the meal
                                        const isChecked = meal.ingredients.some(ing => 
                                            ing.category === categoryKey && String(ing.itemId) === String(item.id)
                                        );
                                        return `
                                            <div class="ingredient-checkbox-item">
                                                <input type="checkbox" 
                                                       id="ing-${categoryKey}-${item.id}"
                                                       value='${value}'
                                                       ${isChecked ? 'checked' : ''}>
                                                <label for="ing-${categoryKey}-${item.id}">${item.name}</label>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                });

                selector.innerHTML = html;
                modal.classList.add('show');
            }
        }

        function confirmEditMeal() {
            if (currentEditMeal === null) return;

            // Get selected ingredients
            const checkboxes = document.querySelectorAll('#ingredientSelector input[type="checkbox"]:checked');
            const ingredients = Array.from(checkboxes).map(cb => {
                try {
                    return JSON.parse(cb.value);
                } catch (e) {
                    console.error('Error parsing ingredient:', cb.value, e);
                    return null;
                }
            }).filter(Boolean);

            if (ingredients.length === 0) {
                alert('Veuillez s√©lectionner au moins un ingr√©dient');
                return;
            }

            // Update meal
            const meal = meals[currentEditMeal];
            if (meal) {
                meal.ingredients = ingredients;
                saveToLocalStorage();
                renderMeals();
            }

            closeMealModal();
            currentEditMeal = null;
        }

        // Dropdown menu functions
        function toggleItemMenu(event, category, itemId) {
            event.stopPropagation();
            const menuId = `menu-${category}-${itemId}`;
            const menu = document.getElementById(menuId);
            const button = event.target;
            
            // Close all other menus
            document.querySelectorAll('.item-dropdown').forEach(dropdown => {
                if (dropdown.id !== menuId) {
                    dropdown.classList.remove('show');
                    dropdown.classList.remove('open-upward');
                }
            });
            
            // Remove active state from all buttons
            document.querySelectorAll('.item-menu-btn').forEach(btn => {
                if (btn !== button) {
                    btn.classList.remove('active');
                }
            });
            
            // Toggle current menu
            const isShowing = menu.classList.contains('show');
            menu.classList.toggle('show');
            button.classList.toggle('active');
            
            // Check if menu should open upward
            if (menu.classList.contains('show')) {
                setTimeout(() => {
                    const rect = menu.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    
                    // If menu would be cut off at bottom, open upward
                    if (rect.bottom > viewportHeight - 20) {
                        menu.classList.add('open-upward');
                    } else {
                        menu.classList.remove('open-upward');
                    }
                }, 10);
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.item-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
                dropdown.classList.remove('open-upward');
            });
            document.querySelectorAll('.item-menu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function filterItems(items) {
            let filtered = items;

            // Apply status filter
            if (currentFilter === 'checked') {
                // Show items marked to buy
                filtered = filtered.filter(item => item.checked);
            } else if (currentFilter === 'active') {
                // Show items not selected
                filtered = filtered.filter(item => !item.checked);
            }

            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            return filtered;
        }

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';

            let hasVisibleItems = false;

            Object.keys(CATEGORIES).forEach(categoryKey => {
                const items = groceryList[categoryKey] || [];
                const filteredItems = filterItems(items);

                if (filteredItems.length > 0) {
                    hasVisibleItems = true;
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category';

                    const category = CATEGORIES[categoryKey];
                    const isCollapsed = collapsedCategories[categoryKey] || false;
                    
                    categoryDiv.innerHTML = `
                        <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${categoryKey}')">
                            <span class="category-icon">${category.icon}</span>
                            <span class="category-title">${category.name}</span>
                            <span class="category-count">${filteredItems.length}</span>
                            <span class="category-chevron ${isCollapsed ? 'collapsed' : ''}">‚ñº</span>
                        </div>
                        <div class="items-list ${isCollapsed ? 'collapsed' : ''}" data-category="${categoryKey}">
                            ${filteredItems.map(item => `
                                <div class="item ${item.checked ? 'checked' : ''}" 
                                     draggable="true" 
                                     data-item-id="${item.id}"
                                     data-category="${categoryKey}">
                                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                                    <input type="checkbox" class="item-checkbox" 
                                           ${item.checked ? 'checked' : ''}
                                           onchange="toggleItem('${categoryKey}', ${item.id})">
                                    <span class="item-name">${item.name}</span>
                                    <div class="item-actions">
                                        <button class="item-menu-btn" onclick="toggleItemMenu(event, '${categoryKey}', ${item.id})" title="Actions">
                                            ‚ãÆ
                                        </button>
                                        <div class="item-dropdown" id="menu-${categoryKey}-${item.id}">
                                            <button class="item-dropdown-item rename" onclick="openRenameModal('${categoryKey}', ${item.id}); closeAllMenus();">
                                                ‚úèÔ∏è Renommer
                                            </button>
                                            <button class="item-dropdown-item move" onclick="openMoveModal('${categoryKey}', ${item.id}); closeAllMenus();">
                                                üìÅ D√©placer
                                            </button>
                                            <button class="item-dropdown-item delete" onclick="deleteItem('${categoryKey}', ${item.id}); closeAllMenus();">
                                                üóëÔ∏è Supprimer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    container.appendChild(categoryDiv);
                }
            });

            if (!hasVisibleItems) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <p>Aucun article dans votre liste</p>
                    </div>
                `;
            }

            updateStats();
            initializeDragAndDrop();
            updateCollapseAllButton();
        }

        function updateCollapseAllButton() {
            const btn = document.getElementById('collapseAllBtn');
            if (!btn) return;
            
            const visibleCategories = Object.keys(CATEGORIES).filter(key => {
                const items = groceryList[key] || [];
                return filterItems(items).length > 0;
            });
            
            const allCollapsed = visibleCategories.every(key => collapsedCategories[key]);
            
            if (allCollapsed) {
                btn.classList.add('collapsed');
            } else {
                btn.classList.remove('collapsed');
            }
        }

        function updateStats() {
            let total = 0;
            let checked = 0;

            Object.values(groceryList).forEach(items => {
                total += items.length;
                checked += items.filter(item => item.checked).length;
            });

            document.getElementById('totalItems').textContent = total;
            document.getElementById('checkedItems').textContent = checked;
            document.getElementById('remainingItems').textContent = total - checked;
        }

        // Drag and Drop functionality
        let draggedItem = null;

        function initializeDragAndDrop() {
            const items = document.querySelectorAll('.item[draggable="true"]');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedItem = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            if (e.target.classList.contains('item')) {
                e.target.classList.add('drag-over');
            }
            
            return false;
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('item')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const target = e.target.closest('.item');
            if (draggedItem && target && draggedItem !== target) {
                const draggedCategory = draggedItem.dataset.category;
                const draggedItemId = parseInt(draggedItem.dataset.itemId);
                const targetCategory = target.dataset.category;
                const targetItemId = parseInt(target.dataset.itemId);

                // Find items
                const draggedItemIndex = groceryList[draggedCategory].findIndex(item => item.id === draggedItemId);
                const targetItemIndex = groceryList[targetCategory].findIndex(item => item.id === targetItemId);

                if (draggedCategory === targetCategory) {
                    // Reorder within same category
                    const [removed] = groceryList[draggedCategory].splice(draggedItemIndex, 1);
                    groceryList[draggedCategory].splice(targetItemIndex, 0, removed);
                } else {
                    // Move to different category
                    const [removed] = groceryList[draggedCategory].splice(draggedItemIndex, 1);
                    groceryList[targetCategory].splice(targetItemIndex, 0, removed);
                }

                saveToLocalStorage();
                renderCategories();
            }

            return false;
        }

        // Drag and drop for meals
        let draggedMeal = null;

        function initializeMealsDragAndDrop() {
            const mealItems = document.querySelectorAll('.meal-item[draggable="true"]');
            
            mealItems.forEach(item => {
                item.addEventListener('dragstart', handleMealDragStart);
                item.addEventListener('dragend', handleMealDragEnd);
                item.addEventListener('dragover', handleMealDragOver);
                item.addEventListener('drop', handleMealDrop);
                item.addEventListener('dragleave', handleMealDragLeave);
            });
        }

        function handleMealDragStart(e) {
            draggedMeal = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleMealDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.meal-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleMealDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            if (e.target.classList.contains('meal-item') || e.target.closest('.meal-item')) {
                const mealItem = e.target.classList.contains('meal-item') ? e.target : e.target.closest('.meal-item');
                mealItem.classList.add('drag-over');
            }
            
            return false;
        }

        function handleMealDragLeave(e) {
            const mealItem = e.target.classList.contains('meal-item') ? e.target : e.target.closest('.meal-item');
            if (mealItem) {
                mealItem.classList.remove('drag-over');
            }
        }

        function handleMealDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const target = e.target.closest('.meal-item');
            if (draggedMeal && target && draggedMeal !== target) {
                const draggedMealId = draggedMeal.dataset.mealId;
                const targetMealId = target.dataset.mealId;

                // Get all meal IDs in current order
                const mealIds = Object.keys(meals);
                const draggedIndex = mealIds.indexOf(draggedMealId);
                const targetIndex = mealIds.indexOf(targetMealId);

                // Reorder meals
                const newMeals = {};
                const reorderedIds = [...mealIds];
                const [removed] = reorderedIds.splice(draggedIndex, 1);
                reorderedIds.splice(targetIndex, 0, removed);

                reorderedIds.forEach(id => {
                    newMeals[id] = meals[id];
                });

                meals = newMeals;
                saveToLocalStorage();
                renderMeals();
            }

            return false;
        }

        // Event Listeners
        document.getElementById('searchBox').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderCategories();
        });

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                
                // Si on clique sur "√Ä acheter", on d√©plie toutes les cat√©gories
                if (currentFilter === 'checked') {
                    // D√©plier toutes les cat√©gories
                    Object.keys(CATEGORIES).forEach(categoryKey => {
                        collapsedCategories[categoryKey] = false;
                    });
                    saveToLocalStorage();
                }
                
                renderCategories();
            });
        });

        // Initialize
        (async function() {
            // Only initialize if user is authenticated
            if (userId) {
                await initializeDefaultItems();
                renderCategories();
                renderMeals();
                updateArticlesCollapseState();
            } else {
                console.log('‚è≥ En attente de connexion...');
            }
        })();

        // Close modal when clicking outside
        window.onclick = function(event) {
            const moveModal = document.getElementById('moveModal');
            const renameModal = document.getElementById('renameModal');
            const mealModal = document.getElementById('mealModal');
            const settingsModal = document.getElementById('settingsModal');
            const addArticleModal = document.getElementById('addArticleModal');
            
            if (event.target === moveModal) {
                closeMoveModal();
            }
            if (event.target === renameModal) {
                closeRenameModal();
            }
            if (event.target === mealModal) {
                closeMealModal();
            }
            if (event.target === settingsModal) {
                closeSettingsModal();
            }
            if (event.target === addArticleModal) {
                closeAddArticleModal();
            }
            
            // Close dropdowns when clicking outside
            if (!event.target.closest('.item-actions')) {
                closeAllMenus();
            }
        };

        // Handle Enter key in rename input
        document.addEventListener('DOMContentLoaded', function() {
            const renameInput = document.getElementById('renameInput');
            if (renameInput) {
                renameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        confirmRename();
                    }
                });
            }

            // Auth modals Enter key handlers
            const loginCodeInput = document.getElementById('loginCodeInput');
            if (loginCodeInput) {
                loginCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loginWithCode();
                    }
                });
            }

            const confirmCodeInput = document.getElementById('confirmCodeInput');
            if (confirmCodeInput) {
                confirmCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        createAccount();
                    }
                });
            }

            // Add article modal Enter key handler
            const modalArticleName = document.getElementById('modalArticleName');
            if (modalArticleName) {
                modalArticleName.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        confirmAddArticle();
                    }
                });
            }
        });

        // Register Service Worker for PWA
        let swRegistration = null;
        let updateAvailable = false;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
                        swRegistration = registration;

                        // V√©rifier les mises √† jour toutes les 5 minutes
                        setInterval(function() {
                            registration.update();
                        }, 300000); // 5 minutes

                        // D√©tecter quand une nouvelle version est en attente
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nouvelle version disponible !
                                    console.log('üîî Nouvelle mise √† jour disponible !');
                                    updateAvailable = true;
                                    setUpdateStatus('available');
                                }
                            });
                        });

                        // V√©rification initiale
                        if (registration.waiting) {
                            updateAvailable = true;
                            setUpdateStatus('available');
                        }
                    })
                    .catch(function(error) {
                        console.log('‚ùå √âchec enregistrement Service Worker:', error);
                        setUpdateStatus('error');
                    });

                // Rafra√Æchir quand le nouveau service worker prend le contr√¥le
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', function() {
                    if (!refreshing) {
                        refreshing = true;
                        window.location.reload();
                    }
                });
            });
        }

        function setUpdateStatus(status) {
            const iconEl = document.getElementById('updateStatusIcon');
            const textEl = document.getElementById('updateStatusText');
            
            if (!iconEl || !textEl) return;
            
            switch(status) {
                case 'checking':
                    iconEl.textContent = 'üîÑ';
                    iconEl.classList.add('checking');
                    textEl.textContent = 'V√©rification...';
                    break;
                case 'uptodate':
                    iconEl.textContent = '‚úÖ';
                    iconEl.classList.remove('checking');
                    textEl.textContent = '√Ä jour';
                    break;
                case 'available':
                    iconEl.textContent = 'üîî';
                    iconEl.classList.remove('checking');
                    textEl.textContent = 'Mise √† jour !';
                    break;
                case 'error':
                    iconEl.textContent = '‚ö†Ô∏è';
                    iconEl.classList.remove('checking');
                    textEl.textContent = 'Erreur';
                    break;
            }
        }

        async function checkForUpdates() {
            if (!swRegistration) {
                alert('Service Worker non disponible. Assurez-vous d\'utiliser l\'app depuis GitHub Pages.');
                return;
            }

            setUpdateStatus('checking');

            try {
                // Forcer la v√©rification
                await swRegistration.update();
                
                // Attendre un peu pour laisser le temps au service worker de se mettre √† jour
                setTimeout(function() {
                    if (swRegistration.waiting || updateAvailable) {
                        // Mise √† jour disponible
                        setUpdateStatus('available');
                        
                        if (confirm('‚ú® Une nouvelle version est disponible !\n\nVoulez-vous mettre √† jour maintenant ?\n\n(Vos donn√©es seront conserv√©es)')) {
                            updateApp();
                        }
                    } else {
                        // D√©j√† √† jour
                        setUpdateStatus('uptodate');
                        
                        // Remettre l'ic√¥ne normale apr√®s 2 secondes
                        setTimeout(function() {
                            setUpdateStatus('uptodate');
                        }, 2000);
                    }
                }, 1000);
            } catch (error) {
                console.error('Erreur lors de la v√©rification:', error);
                setUpdateStatus('error');
            }
        }

        function updateApp() {
            if (swRegistration && swRegistration.waiting) {
                // Dire au service worker en attente de prendre le contr√¥le
                swRegistration.waiting.postMessage({ action: 'skipWaiting' });
            }
        }
    </script>
</body>
</html>
