name: ğŸ§ª Tests AutomatisÃ©s

# DÃ©clencher les tests Ã  chaque push sur main et pull request
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Permet aussi de lancer manuellement depuis GitHub
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      # 1. RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v3
      
      # 2. Installer Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      # 3. Installer Playwright (navigateur pour les tests)
      - name: ğŸ­ Installer Playwright
        run: |
          npm init -y
          npm install -D @playwright/test
          npx playwright install chromium
      
      # 4. CrÃ©er le script de test
      - name: ğŸ“ CrÃ©er le script de test
        run: |
          cat > test-runner.js << 'EOF'
          const { chromium } = require('@playwright/test');

          (async () => {
            console.log('ğŸš€ Lancement des tests automatisÃ©s...');
            
            const browser = await chromium.launch({
              headless: true
            });
            
            const context = await browser.newContext();
            const page = await context.newPage();
            
            // Ã‰couter les logs de la console
            page.on('console', msg => {
              const text = msg.text();
              if (text.includes('Firebase') || text.includes('Test')) {
                console.log('ğŸ“Š', text);
              }
            });
            
            // Charger la page de tests
            console.log('ğŸ“„ Chargement de la page de tests...');
            await page.goto('file://' + process.cwd() + '/tests.html');
            
            // Attendre que la page soit prÃªte
            await page.waitForTimeout(2000);
            
            // Lancer tous les tests
            console.log('â–¶ï¸  Lancement de tous les tests...');
            await page.evaluate(() => {
              return runAllTests();
            });
            
            // Attendre que tous les tests soient terminÃ©s (max 30 secondes)
            console.log('â³ Attente de la fin des tests...');
            await page.waitForTimeout(30000);
            
            // RÃ©cupÃ©rer les rÃ©sultats
            const results = await page.evaluate(() => {
              const testItems = document.querySelectorAll('.test-item');
              const tests = [];
              
              testItems.forEach(item => {
                const name = item.querySelector('h3').textContent;
                const status = item.className.includes('passed') ? 'passed' : 
                              item.className.includes('failed') ? 'failed' : 'running';
                const steps = Array.from(item.querySelectorAll('.step')).map(s => s.textContent);
                
                tests.push({ name, status, steps });
              });
              
              return tests;
            });
            
            // Afficher les rÃ©sultats
            console.log('\nğŸ“Š ========== RÃ‰SULTATS DES TESTS ==========\n');
            
            let passed = 0;
            let failed = 0;
            
            results.forEach(test => {
              const icon = test.status === 'passed' ? 'âœ…' : 
                          test.status === 'failed' ? 'âŒ' : 'ğŸ”„';
              
              console.log(`${icon} ${test.name}: ${test.status.toUpperCase()}`);
              
              if (test.status === 'passed') passed++;
              if (test.status === 'failed') failed++;
              
              // Afficher les Ã©tapes
              test.steps.forEach(step => {
                console.log(`   ${step}`);
              });
              console.log('');
            });
            
            const total = results.length;
            const percentage = Math.round((passed / total) * 100);
            
            console.log('============================================');
            console.log(`ğŸ“ˆ RÃ©sumÃ©: ${passed}/${total} tests rÃ©ussis (${percentage}%)`);
            console.log('============================================\n');
            
            await browser.close();
            
            // Ã‰chouer si des tests ont Ã©chouÃ©
            if (failed > 0) {
              console.error(`âŒ ${failed} test(s) ont Ã©chouÃ©`);
              process.exit(1);
            } else {
              console.log('âœ… Tous les tests ont rÃ©ussi !');
              process.exit(0);
            }
          })();
          EOF
      
      # 5. ExÃ©cuter les tests
      - name: ğŸ§ª ExÃ©cuter les tests
        run: node test-runner.js
      
      # 6. Upload des rÃ©sultats (mÃªme en cas d'Ã©chec)
      - name: ğŸ“¤ Upload des rÃ©sultats
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            *.log
            screenshots/
          retention-days: 30
